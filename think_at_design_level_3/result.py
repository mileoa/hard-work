# –û—Ç—á–µ—Ç
# –ü–æ–Ω–∏–º–∞—é —á—Ç–æ  —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ 1:1 —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–∞.
# –¢.–µ. –Ω–µ—Ç –ª–∏—à–Ω–µ–≥–æ –∫–æ–¥–∞ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω–æ–≥–æ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ. –í—Å–µ –¥–µ–ª–∞–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã –æ–±—ä–µ–∫—Ç–æ–≤.
# –ü—Ä–∏—á–µ–º –æ–±—ä–µ–∫—Ç—ã —Ä–µ–∞–ª–∏–∑—É—é—Ç –ø–æ–Ω—è—Ç–∏—è –∏–∑ –¥–∏–∑–∞–π–Ω–∞ –∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Ü–µ–ø–æ—á–∫—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å–≤—Ç–∏–π.
# –ò–∑-–∑–∞ —Ç–æ–≥–æ —á—Ç–æ –æ–Ω–∏ –≤—ã—Å—Ç—Ä–æ–µ–Ω—ã –≤ —Ü–µ–ø–æ—á–∫—É —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–∏—Ü–∏–ø "–≤—Å–µ –∏–ª–∏ –Ω–∏—á–µ–≥–æ". –≠—Ç–æ—Ç –ø—Ä–∏–Ω—Ü–∏–ø –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å
# —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –¥–∞—à–±–æ—Ä–¥–µ, —Ç–æ –º—ã –ø–æ—Å—á–∏—Ç–∞–µ–º —ç—Ç—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–µ—à–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏. –ù–æ –µ—Å–ª–∏ –º—ã —ç—Ç—É —Å—Ç–∞—Ç—Å–∏—Ç–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å
# –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º—Å—è, —Ç–æ –º—ã –µ—ë –Ω–µ –¥–æ–∞–≤–±–ª—è–µ–º –≤ "–ø–æ—Ç–æ–∫". –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∏–∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–π –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –ø–æ–∫–∞ –º—ã –Ω–µ –≤–µ—Ä–Ω–µ–º –µ—ë.
# –¢–∞–∫–∂–µ —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫ –Ω–∞–¥–æ —Å—Ç–∞—Ä–∞—Ç—å—Å—è –¥–µ–ª–∞—Ç—å –ª–µ–≥–∫–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–º. –¢.–µ. —á—Ç–æ–±—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –∏–ª–∏ –Ω–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥–∞.
# –•–æ—Ç—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∂—É—Ç–∫–∏–º –∫–æ–Ω—Ñ–∏–≥–∞–º –Ω–∞ 100 —Ñ–∞–π–ª–æ–≤ —Å–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫ –≤ –∫–∞–∂–¥–æ–º. –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Å–µ —Ä–∞–≤–Ω–æ —É–¥–∞—á–Ω–µ–µ —á–µ–º –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –∫–æ–¥ –≤—Ä—É—á–Ω—É—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π.


# 1
# –°–ª–æ–≤–µ—Å–Ω—ã–π –¥–∏–∑–∞–π–Ω:
# –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–ø—Ä–≤–∏—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π,
# –ø–æ –≤—Å–µ–º –∞–¥—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ. –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.
# –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–≤—ã–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–ª–µ–¥—É—é—â–∏–π –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
# –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –ø–æ–∫–∞ –æ—Ç—Ä–∞–≤–∏—Ç–µ–ª–∏ –Ω–µ –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è. –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: —É—Å–ø–µ—à–µ–Ω, –Ω–µ—É—Å–ø–µ—à–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å.
# –ï—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –û–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ —Å—Ç—Ä–æ–∫–æ–π –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª –¥–æ—Å—Ç–∞–≤–∫–∏. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ–º –±—ã—Ç—å –ø—É—Å—Ç—ã–º.
# –ï—Å—Ç—å –∞–¥—Ä–µ—Å –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Ä–∞–º–∫–∞—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å–≤—É—é—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ –¥–æ—Å—Ç–∞–≤–∫–∏. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –≤ —Å–∏—Å—Ç–µ–º–µ,
# –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ. –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–µ—Ç –∫–∞–∫–æ–π –∞–¥—Ä–µ—Å —Å–æ–æ—Ç–≤–µ—Ç—Å–≤—É–µ—Ç –∫–∞–¥–∂–æ–º—É —Ç–∏–ø—É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∞–¥—Ä–µ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è.
# –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, —Ç–æ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
# –ï—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–º. –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–º–µ–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
# –æ —Å–∏—Å—Ç–µ–º–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ. –ü–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç–ø—Ä–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: —É—Å–ø–µ—à–Ω–∞, –Ω–µ—É—Å–ø–µ—à–Ω–∞, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å.
# –ï—Å—Ç—å –º–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ß–µ—Ä–µ–∑ –Ω–µ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–æ—á–µ—Ä–¥–µ–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ó–Ω–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π.
# –ó–Ω–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: —É—Å–ø–µ—à–µ–Ω, –Ω–µ—É—Å–ø–µ—à–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å.


# –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–≤–µ—Å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
# –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—é –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞.

# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ

import smtplib
from abc import ABC, abstractmethod
from email.mime.text import MIMEText
from typing import Final

import requests
from pydantic import BaseModel, EmailStr


class UserDestinations(BaseModel):
    email: EmailStr
    telegram_chat_id: str


class MultiChannelNotificationSenderATD(ABC):
    SEND_FIRST_SUCCESSFUL_NILL: Final[int] = 0
    SEND_FIRST_SUCCESSFUL_ERR: Final[int] = 1
    SEND_FIRST_SUCCESSFUL_OK: Final[int] = 2

    def __init__(self):
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —Å–æ–∑–¥–∞–Ω –º–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        """
        pass

    # –ö–æ–º–∞–Ω–¥—ã
    @abstractmethod
    def send_first_successful(
        self, message: str, user_destinations: UserDestinations
    ) -> None:
        """
        –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç —Å–æ–±–æ—â–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        —á–µ—Ä–µ–∑ –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏
        –ø–æ —Å–æ–æ—Ç–≤—É–µ—Ç—Å–≤—É—é—â–µ–º—É —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
        """
        pass

    @abstractmethod
    def set_user_telegram_sender(
        self, sender: "NotificationSenderATD"
    ) -> None:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        –≤ —Ç–µ–ª–µ–≥–∞–º –¥–æ–±–∞–≤–ª–µ–Ω —Å–ª–µ–¥—É—é—â–∏–º –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏
        """
        pass

    @abstractmethod
    def set_email_sender(self, sender: "NotificationSenderATD") -> None:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —É–∫–∞–∑–∞–Ω–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å email –¥–æ–±–∞–≤–ª–µ–Ω
        —Å–ª–µ–¥—É—é—â–∏–º –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã
    @abstractmethod
    def is_email_sender(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç–∞–Ω–æ–ª–µ–Ω –ª–∏ –æ—Ç–ø—Ä–∞–≤—â–∏–∫ email
        """
        pass

    @abstractmethod
    def is_telegram_sender(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å—Ç–∞–Ω–æ–ª–µ–Ω –ª–∏ –æ—Ç–ø—Ä–∞–≤—â–∏–∫ telegram
        """

        pass

    @abstractmethod
    def get_priority(self) -> list["NotificationSenderATD"]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    @abstractmethod
    def get_send_first_successful_status(self) -> int:
        """
        –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ SEND_FIRST_SUCCESSFUL_*
        """
        pass


class NotificationSenderATD:

    SEND_NILL: Final[int] = 0
    SEND_ERR: Final[int] = 1
    SEND_OK: Final[int] = 2

    def __init__(self, *args) -> None:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –°–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤—â–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        """
        pass

    # –ö–æ–º–∞–Ω–¥—ã
    @abstractmethod
    def send(self, message: str, destination: str) -> None:
        """
        –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç —Å–æ–±–æ—â–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç message –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É destination
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã
    @abstractmethod
    def get_type(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    @abstractmethod
    def get_send_status(self) -> int:
        """
        –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ SEND_*
        """
        pass


class EmailSender(NotificationSenderATD):

    def __init__(
        self, smtp_host: str, smtp_port: int, login: str, password: str
    ):
        self._smtp_host = smtp_host
        self._smtp_port = smtp_port
        self._login = login
        self._password = password
        self._send_status = self.SEND_NILL
        self._type = "email"

    def send(self, message: str, destination: str) -> None:
        if not message:
            self._send_status = self.SEND_ERR
            raise ValueError("Message cannot be empty")

        try:
            server = smtplib.SMTP(
                self._smtp_host,
                self._smtp_port,
            )
            server.starttls()
            server.login(self._login, self._password)

            msg = MIMEText(message)
            msg["Subject"] = "Notification"
            msg["From"] = self._login
            msg["To"] = destination

            server.send_message(msg)
            self._send_status = self.SEND_OK
        except Exception:
            self._send_status = self.SEND_ERR
        finally:
            if server:
                server.quit()

    def get_type(self) -> str:
        return self._type

    def get_send_status(self):
        return self._send_status


class UserTelegramSender(NotificationSenderATD):

    def __init__(self, bot_token: str):
        self._bot_token = bot_token
        self._api_url = f"https://api.telegram.org/bot{self._bot_token}"
        self._send_status = self.SEND_NILL
        self._type = "telegram"

    def send(self, message: str, destination: str) -> None:
        """destination ‚Äî chat_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if not message:
            self._send_status = self.SEND_ERR
            raise ValueError("Message cannot be empty")
        try:
            url = f"{self._api_url}/sendMessage"
            payload = {"chat_id": destination, "text": message}
            response = requests.post(url, json=payload)
            if response.status_code == 200:
                self._send_status = self.SEND_OK
                return
            self._send_status = self.SEND_ERR
        except Exception:
            self._send_status = self.SEND_ERR

    def get_type(self) -> str:
        return self._type

    def get_send_status(self):
        return self._send_status


class MultiChannelNotificationSender(MultiChannelNotificationSenderATD):

    def __init__(self) -> None:
        self._send_first_successful_status: int = (
            self.SEND_FIRST_SUCCESSFUL_NILL
        )
        self._sender_priority: list["NotificationSenderATD"] = []
        self._is_email_sender: bool = False
        self._is_telegram_sender: bool = False
        self._type_to_destination: dict[str, str] = {
            "email": "email",
            "telegram": "telegram_chat_id",
        }

    def send_first_successful(
        self, message: str, user_destinations: UserDestinations
    ) -> None:
        if not message:
            raise ValueError("Message cannot be empty")
        for sender in self._sender_priority:
            sender_type: str = sender.get_type()
            destination: str = getattr(
                user_destinations, self._type_to_destination[sender_type]
            )
            sender.send(message, destination)
            if sender.get_send_status() == sender.SEND_OK:
                self._send_first_successful_status = (
                    self.SEND_FIRST_SUCCESSFUL_OK
                )
                break
            self._send_first_successful_status = self.SEND_FIRST_SUCCESSFUL_ERR

    def set_user_telegram_sender(
        self, sender: "NotificationSenderATD"
    ) -> None:
        self._sender_priority.append(sender)
        self._is_telegram_sender = True

    def set_email_sender(self, sender: "NotificationSenderATD") -> None:
        self._sender_priority.append(sender)
        self._is_email_sender = True

    def is_telegram_sender(self) -> bool:
        return self._is_telegram_sender

    def is_email_sender(self) -> bool:
        return self._is_email_sender

    def get_priority(self) -> list["NotificationSenderATD"]:
        return self._sender_priority

    def get_send_first_successful_status(self) -> int:
        return self._send_first_successful_status


# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ
import smtplib
from abc import ABC, abstractmethod
from email.mime.text import MIMEText
from typing import Final

import requests
from pydantic import BaseModel, EmailStr, Field


class UserDestinations(BaseModel):
    email: EmailStr
    telegram_chat_id: str


class Message(BaseModel):
    text: str = Field(min_length=1)


class MultiChannelNotificationSenderATD(ABC):
    SEND_FIRST_SUCCESSFUL_NILL: Final[int] = 0
    SEND_FIRST_SUCCESSFUL_ERR: Final[int] = 1
    SEND_FIRST_SUCCESSFUL_OK: Final[int] = 2

    def __init__(self, priority: list["NotificationSenderATD"]):
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —Å–æ–∑–¥–∞–Ω –º–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ–Ω–æ—Å—Ç—å—é
        """
        pass

    # –ö–æ–º–∞–Ω–¥—ã
    @abstractmethod
    def send_first_successful(
        self, message: Message, user_destinations: UserDestinations
    ) -> None:
        """
        –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç —Å–æ–±–æ—â–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        —á–µ—Ä–µ–∑ –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏
        –ø–æ —Å–æ–æ—Ç–≤—É–µ—Ç—Å–≤—É—é—â–µ–º—É —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
        """
        pass

    @abstractmethod
    def get_priority(self) -> list["NotificationSenderATD"]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–ø–æ—Å–æ–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    @abstractmethod
    def get_send_first_successful_status(self) -> int:
        """
        –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ SEND_FIRST_SUCCESSFUL_*
        """
        pass


class NotificationSenderATD:

    SEND_NILL: Final[int] = 0
    SEND_ERR: Final[int] = 1
    SEND_OK: Final[int] = 2

    def __init__(self, *args) -> None:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –°–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤—â–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        """
        pass

    # –ö–æ–º–∞–Ω–¥—ã
    @abstractmethod
    def send(self, message: Message, destination: str) -> None:
        """
        –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç —Å–æ–±–æ—â–µ–Ω–∏—è –Ω–µ –ø—É—Å—Ç
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: —Ç–µ–∫—Å—Ç message –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É destination
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã
    @abstractmethod
    def get_type(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        """
        pass

    # –ó–∞–ø—Ä–æ—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
    @abstractmethod
    def get_send_status(self) -> int:
        """
        –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ SEND_*
        """
        pass


class EmailSender(NotificationSenderATD):

    def __init__(
        self, smtp_host: str, smtp_port: int, login: str, password: str
    ):
        self._smtp_host: Final[str] = smtp_host
        self._smtp_port: Final[int] = smtp_port
        self._login: Final[str] = login
        self._password: Final[str] = password
        self._send_status: int = self.SEND_NILL
        self._type: Final[str] = "email"

    def send(self, message: Message, destination: str) -> None:
        if destination == "":
            self._send_status = self.SEND_ERR
            raise ValueError("Destination cannot be empty")
        try:
            server = smtplib.SMTP(
                self._smtp_host,
                self._smtp_port,
            )
            server.starttls()
            server.login(self._login, self._password)

            msg = MIMEText(message.text)
            msg["Subject"] = "Notification"
            msg["From"] = self._login
            msg["To"] = destination

            server.send_message(msg)
            self._send_status = self.SEND_OK
        except Exception:
            self._send_status = self.SEND_ERR
        finally:
            if server:
                server.quit()

    def get_type(self) -> str:
        return self._type

    def get_send_status(self):
        return self._send_status


class UserTelegramSender(NotificationSenderATD):

    def __init__(self, bot_token: str):
        self._bot_token: Final[str] = bot_token
        self._api_url: Final[str] = (
            f"https://api.telegram.org/bot{self._bot_token}"
        )
        self._send_status: int = self.SEND_NILL
        self._type: Final[str] = "telegram"

    def send(self, message: Message, destination: str) -> None:
        """destination ‚Äî chat_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if destination == "":
            self._send_status = self.SEND_ERR
            raise ValueError("Destination cannot be empty")
        try:
            url = f"{self._api_url}/sendMessage"
            payload = {"chat_id": destination, "text": message.text}
            response = requests.post(url, json=payload)
            if response.status_code == 200:
                self._send_status = self.SEND_OK
                return
            self._send_status = self.SEND_ERR
        except Exception:
            self._send_status = self.SEND_ERR

    def get_type(self) -> str:
        return self._type

    def get_send_status(self):
        return self._send_status


class MultiChannelNotificationSender(MultiChannelNotificationSenderATD):

    def __init__(self, priority: list["NotificationSenderATD"]) -> None:
        self._send_first_successful_status: int = (
            self.SEND_FIRST_SUCCESSFUL_NILL
        )
        self._sender_priority: list["NotificationSenderATD"] = priority[:]
        self._type_to_destination: dict[str, str] = {
            "email": "email",
            "telegram": "telegram_chat_id",
        }

    def send_first_successful(
        self, message: Message, user_destinations: UserDestinations
    ) -> None:
        for sender in self._sender_priority:
            sender_type: str = sender.get_type()
            destination: str = getattr(
                user_destinations, self._type_to_destination[sender_type]
            )
            sender.send(message.text, destination)
            if sender.get_send_status() == sender.SEND_OK:
                self._send_first_successful_status = (
                    self.SEND_FIRST_SUCCESSFUL_OK
                )
                break
            self._send_first_successful_status = self.SEND_FIRST_SUCCESSFUL_ERR

    def get_priority(self) -> list["NotificationSenderATD"]:
        return self._sender_priority

    def get_send_first_successful_status(self) -> int:
        return self._send_first_successful_status


# 2
# –°–ª–æ–≤–µ—Å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:
# –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç—á–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ø–æ
# –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ—Ç—Ä–µ–∑–∫–∞–º: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü –∏ —Ç–¥. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ –∫–∞–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º —Å—Ç—Ä–æ–∏—Ç—å —Ç–æ—Ç –∏–ª–∏ –∏–Ω–æ–π –æ—Ç—á–µ—Ç.
# –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –º–æ–≥—É—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å. –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π —Å–ø–∏—Å–∏–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Å—Ç—Ä–æ–∏—Ç—Å—è –æ—Ç—á–µ—Ç. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ
# –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤.

# –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–≤–µ—Å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å–≤—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—é, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤ —Å—Ö–µ–º–µ "–≤—Å–µ –∏–ª–∏ –Ω–∏—á–µ–≥–æ" –∏ —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–π, —á—Ç–æ–±—ã –Ω—É–∂–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã,
# –ø—Ä–∞–≤–∞ –≤—ã–±–∏—Ä–∞–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞. –¢–∞–∫–∂–µ —Ç–∏–ø—ã –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –º–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥.

# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ


class ReportListView(WebReportsMixin, TemplateView):
    template_name = "reports/report_list.html"
    permission_required = [
        "vehicles.view_vehicle",
        "vehicles.view_driver",
        "vehicles.view_brand",
        "enterprises.view_enterprise",
        "tracking.view_trip",
    ]

    def get_enterprises(self):
        if self.request.user.is_superuser:
            return Enterprise.objects.all()
        return self.request.user.manager.enterprises.all()

    def get_vehicles(self):
        if self.request.user.is_superuser:
            return Vehicle.objects.all()
        return Vehicle.objects.filter(enterprise__in=self.get_enterprises())

    def get_brands(self):
        return Brand.objects.all()

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        today = datetime.now().date()
        month_ago = today - timedelta(days=30)

        context.update(
            {
                "enterprises": self.get_enterprises(),
                "vehicles": self.get_vehicles(),
                "brands": self.get_brands(),
                "period_choices": BaseReport.PERIOD_CHOICES,
                "default_start_date": month_ago.strftime("%Y-%m-%d"),
                "default_end_date": today.strftime("%Y-%m-%d"),
            }
        )

        return context

    def post(self, request, *args, **kwargs):
        report_type = request.POST.get("report_type")

        if report_type not in [
            "vehicle_mileage",
            "vehicle_sales",
            "driver_assignment",
        ]:
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –æ—Ç—á–µ—Ç–∞")
            )

        try:
            start_date = datetime.strptime(
                request.POST.get("start_date"), "%Y-%m-%d"
            ).date()
            end_date = datetime.strptime(
                request.POST.get("end_date"), "%Y-%m-%d"
            ).date()
        except (ValueError, TypeError):
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã")
            )

        period = request.POST.get("period")
        if period not in ["day", "week", "month", "year"]:
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥")
            )

        url_params = {
            "start_date": start_date.strftime("%Y-%m-%d"),
            "end_date": end_date.strftime("%Y-%m-%d"),
            "period": period,
        }

        if report_type == "vehicle_mileage":
            vehicle_id = request.POST.get("vehicle_id")
            enterprise_id = request.POST.get("mileage_enterprise_id")

            if vehicle_id:
                url_params["vehicle_id"] = vehicle_id
            elif enterprise_id:
                url_params["enterprise_id"] = enterprise_id
            else:
                return self.render_to_response(
                    self.get_context_data(
                        error="–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–ª–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ"
                    )
                )

        if report_type == "vehicle_sales":
            brand_id = request.POST.get("brand_id")
            enterprise_id = request.POST.get("sales_enterprise_id")

            if brand_id:
                url_params["brand_id"] = brand_id
            if enterprise_id:
                url_params["enterprise_id"] = enterprise_id

        if report_type == "driver_assignment":
            enterprise_ids = request.POST.getlist("enterprise_id")
            enterprise_ids = ",".join(enterprise_ids)
            if enterprise_ids:
                url_params["enterprise_ids"] = enterprise_ids

        url = reverse(f"reports:report_{report_type}")
        param_string = "&".join([f"{k}={v}" for k, v in url_params.items()])

        return HttpResponseRedirect(f"{url}?{param_string}")


# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ
from abc import ABC, abstractmethod


class ReportContextATD(abc):

    def __init__(self):
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞
        """
        pass

    @abstractmethod
    def get_url_params(self, request) -> dict[str, str]:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è querystring
        """
        pass

    @abstractmethod
    def get_queryset_context(self) -> dict[str, object]:
        """
        –ü–æ—Å—Ç—É—Å–ª–æ–≤–∏–µ: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –µ–≥–æ queryset
        """
        pass


class ReportVehicleMileageContext(ReportContextATD):

    def get_url_params(self, request):
        url_params = {}
        vehicle_id = request.POST.get("vehicle_id")
        enterprise_id = request.POST.get("mileage_enterprise_id")

        if vehicle_id:
            url_params["vehicle_id"] = vehicle_id
        elif enterprise_id:
            url_params["enterprise_id"] = enterprise_id
        else:
            url_params = {"-1": -1}
        return url_params

    def get_queryset_context(self, request) -> dict[str, object]:
        context = {}
        context["enterprises"] = self._get_enterprises(request)
        context["vehicles"] = self._get_vehicles(request)
        return context

    def _get_enterprises(self, request):
        if request.user.is_superuser:
            return Enterprise.objects.all()
        return request.user.manager.enterprises.all()

    def _get_vehicles(self, request):
        if request.user.is_superuser:
            return Vehicle.objects.all()
        return Vehicle.objects.filter(enterprise__in=self._get_enterprises())


class ReportVehicleSalesContext(ReportContextATD):

    def get_url_params(self, request):
        url_params = {}
        brand_id = request.POST.get("brand_id")
        enterprise_id = request.POST.get("sales_enterprise_id")
        if brand_id:
            url_params["brand_id"] = brand_id
        if enterprise_id:
            url_params["enterprise_id"] = enterprise_id
        return url_params

    def get_queryset_context(self, request) -> dict[str, object]:
        context = {}
        context["brands"] = self._get_brands()
        context["vehicles"] = self._get_vehicles(request)
        return context

    def _get_brands(self):
        return Brand.objects.all()

    def _get_vehicles(self, request):
        if request.user.is_superuser:
            return Vehicle.objects.all()
        return Vehicle.objects.filter(enterprise__in=self.get_enterprises())


class ReportDriverAssignmentContext(ReportContextATD):

    def get_url_params(self, request):
        url_params = {}
        enterprise_ids = request.POST.getlist("enterprise_id")
        enterprise_ids = ",".join(enterprise_ids)
        if enterprise_ids:
            url_params["enterprise_ids"] = enterprise_ids
        return url_params

    def get_queryset_context(self, request) -> dict[str, object]:
        context = {}
        context["enterprises"] = self._get_enterprises(request)
        context["vehicles"] = self._get_vehicles(request)
        return context

    def _get_enterprises(self, request):
        if request.user.is_superuser:
            return Enterprise.objects.all()
        return request.user.manager.enterprises.all()

    def _get_vehicles(self, request):
        if request.user.is_superuser:
            return Vehicle.objects.all()
        return Vehicle.objects.filter(enterprise__in=self.get_enterprises())


class ReportListView(WebReportsMixin, TemplateView):
    template_name = "reports/report_list.html"
    permission_required = [
        "vehicles.view_vehicle",
        "vehicles.view_driver",
        "vehicles.view_brand",
        "enterprises.view_enterprise",
        "tracking.view_trip",
    ]

    allowed_report_types = {
        "vehicle_mileage": ReportVehicleMileageContext,
        "vehicle_sales": ReportVehicleSalesContext,
        "driver_assignment": ReportDriverAssignmentContext,
    }

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        today = datetime.now().date()
        month_ago = today - timedelta(days=30)

        context.update(
            {
                "report_types_to_display": self.allowed_report_types,
                "period_choices": BaseReport.PERIOD_CHOICES,
                "default_start_date": month_ago.strftime("%Y-%m-%d"),
                "default_end_date": today.strftime("%Y-%m-%d"),
            }
        )

        for reporty_type, report_context in self.allowed_report_types.items():
            report_context = report_context()
            context.update(report_context.get_queryset_context(self.request))
            del report_context
        return context

    def post(self, request, *args, **kwargs):
        report_type = request.POST.get("report_type")

        if report_type not in self.allowed_report_types.keys():
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –æ—Ç—á–µ—Ç–∞")
            )

        try:
            start_date = datetime.strptime(
                request.POST.get("start_date"), "%Y-%m-%d"
            ).date()
            end_date = datetime.strptime(
                request.POST.get("end_date"), "%Y-%m-%d"
            ).date()
        except (ValueError, TypeError):
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã")
            )

        period = request.POST.get("period")
        if period not in ["day", "week", "month", "year"]:
            return self.render_to_response(
                self.get_context_data(error="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥")
            )

        url_params = {
            "start_date": start_date.strftime("%Y-%m-%d"),
            "end_date": end_date.strftime("%Y-%m-%d"),
            "period": period,
        }

        report_context = self.allowed_report_types[report_type]()
        url_params.update(report_context.get_url_params(request))

        url = reverse(f"reports:report_{report_type}")
        param_string = "&".join([f"{k}={v}" for k, v in url_params.items()])

        return HttpResponseRedirect(f"{url}?{param_string}")


# 3
# 3
# –°–ª–æ–≤–µ—Å–Ω—ã–π –¥–∏–∑–∞–π–Ω:
# –í —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–π –≤–µ–ª–µ—á–∏–Ω–æ–π –∏ —Å—Ç—Ä–æ–∫–æ–π —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç —ç—Ç—É –≤–µ–ª–µ—á–∏–Ω—É.

# –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ª–æ–≤–µ—Å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
# –í —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è –≤–µ–ª–µ—á–∏–Ω—ã —Å—Ç—Ä–æ–∫–æ–π —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º. –¢–∞–∫–∂–µ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤–µ–ª–µ—á–∏–Ω—ã.


# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ
class UserDAO(BaseDAO[User]):
    model = User

    @classmethod
    async def get_booking_statistics(
        cls, session: AsyncSession, telegram_id: int
    ) -> Optional[Dict[str, int]]:
        try:
            # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—â–µ–π —Å—É–º–º—ã
            result = await session.execute(
                select(
                    func.count(Booking.id).label("total_bookings"),
                    func.sum(Booking.price).label("total_amount"),
                )
                .join(User)
                .filter(User.telegram_id == telegram_id)
            )
            stats = result.one_or_none()

            if stats is None:
                return None

            total_bookings, total_amount = stats
            return {
                "total_bookings": total_bookings,
                "total_amount": total_amount
                or 0,  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Å—É–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å None
            }

        except SQLAlchemyError as e:
            logger.info(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}"
            )
            return None
        –¶

    @classmethod
    async def get_booked_products(
        cls, session: AsyncSession, telegram_id: int
    ) -> Optional[List[Booking]]:
        try:
            # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
            result = await session.execute(
                select(User)
                .options(
                    selectinload(User.bookings).selectinload(Booking.product)
                )
                .filter(User.telegram_id == telegram_id)
            )
            user = result.scalar_one_or_none()

            if user is None:
                return None

            return user.bookings

        except SQLAlchemyError as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
            logger.info(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}"
            )
            return None

    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        try:
            now = datetime.now(UTC)

            query = select(
                func.count().label("total_users"),
                func.sum(
                    case(
                        (cls.model.created_at >= now - timedelta(days=1), 1),
                        else_=0,
                    )
                ).label("new_today"),
                func.sum(
                    case(
                        (cls.model.created_at >= now - timedelta(days=7), 1),
                        else_=0,
                    )
                ).label("new_week"),
                func.sum(
                    case(
                        (cls.model.created_at >= now - timedelta(days=30), 1),
                        else_=0,
                    )
                ).label("new_month"),
            )

            result = await session.execute(query)
            stats = result.fetchone()

            statistics = {
                "total_users": stats.total_users,
                "new_today": stats.new_today,
                "new_week": stats.new_week,
                "new_month": stats.new_month,
            }

            logger.info(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞: {statistics}")
            return statistics
        except SQLAlchemyError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            raise


@admin_router.callback_query(
    F.data == "statistic", F.from_user.id.in_(settings.ADMIN_IDS)
)
async def admin_statistic(
    call: CallbackQuery, session_without_commit: AsyncSession
):
    await call.answer("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
    await call.answer("üìä –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")

    stats = await UserDAO.get_statistics(session=session_without_commit)
    stats_message = (
        "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
        f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats['total_users']}\n"
        f"üÜï –ù–æ–≤—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {stats['new_today']}\n"
        f"üìÖ –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {stats['new_week']}\n"
        f"üìÜ –ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü: {stats['new_month']}\n\n"
        "üïí –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç."
    )
    await call.message.edit_text(text=stats_message, reply_markup=admin_kb())


# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ
class UserDAO(BaseDAO[User]):
    model = User

    @classmethod
    async def get_booking_statistics(
        cls, session: AsyncSession, telegram_id: int
    ) -> Optional[Dict[str, int]]:
        try:
            # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—â–µ–π —Å—É–º–º—ã
            result = await session.execute(
                select(
                    func.count(Booking.id).label("total_bookings"),
                    func.sum(Booking.price).label("total_amount"),
                )
                .join(User)
                .filter(User.telegram_id == telegram_id)
            )
            stats = result.one_or_none()

            if stats is None:
                return None

            total_bookings, total_amount = stats
            return {
                "total_bookings": total_bookings,
                "total_amount": total_amount
                or 0,  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Å—É–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å None
            }

        except SQLAlchemyError as e:
            logger.info(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}"
            )
            return None

    @classmethod
    async def get_booked_products(
        cls, session: AsyncSession, telegram_id: int
    ) -> Optional[List[Booking]]:
        try:
            # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
            result = await session.execute(
                select(User)
                .options(
                    selectinload(User.bookings).selectinload(Booking.product)
                )
                .filter(User.telegram_id == telegram_id)
            )
            user = result.scalar_one_or_none()

            if user is None:
                return None

            return user.bookings

        except SQLAlchemyError as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
            logger.info(
                f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}"
            )
            return None

    @classmethod
    async def count_users_by_period(
        cls,
        session: AsyncSession,
        period: Optional[timedelta] = None,
        start_date: Optional[datetime] = None,
        end_date: Optional[datetime] = None,
    ):
        try:
            now = datetime.now(UTC)
            query = select(func.count()).select_from(cls.model)

            if period is not None:
                query = query.where(cls.model.created_at >= now - period)

            if start_date is not None:
                query = query.where(cls.model.created_at >= start_date)

            if end_date is not None:
                query = query.where(cls.model.created_at <= end_date)

            result = await session.execute(query)
            users_count = result.scalar_one()
            logger.info(
                f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥ {start_date} - {end_date}: {users_count}"
            )
            return users_count

        except SQLAlchemyError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            raise


class StatsComputation(ABC):

    def __init__(self, session: AsyncSession):
        pass

    @abstractmethod
    async def compute(self) -> Any:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        """
        pass


@dataclass(frozen=True)
class DashboardStat:

    computation: StatsComputation
    description_for_user: str

    def get_description_for_user(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return self.description_for_user

    def get_computation(self) -> StatsComputation:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–æ—Å–æ–± —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        return self.computation


class Dashboard:
    def __init__(self, stats: List[DashboardStat]):
        """
        –°–æ–∑–¥–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
        """
        self.stats: List[DashboardStat] = stats

    async def get_values(self) -> Dict[DashboardStat, Any]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
        """
        values: Dict[DashboardStat, Any] = await self._compute_all_stats()
        return values

    async def _compute_all_stats(self) -> Dict[DashboardStat, Any]:
        """
        –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
        """
        values: Dict[DashboardStat, Any] = {}
        for stat in self.stats:
            values[stat] = await stat.get_computation().compute()
        return values


class CountUsersLastDay(StatsComputation):

    def __init__(self, session: AsyncSession):
        self._session = session

    async def compute(self) -> int:
        return await UserDAO.count_users_by_period(
            session=self._session, period=timedelta(days=1)
        )


class CountUsersLastWeek(StatsComputation):
    def __init__(self, session: AsyncSession):
        self._session = session

    async def compute(self) -> int:
        return await UserDAO.count_users_by_period(
            session=self._session, period=timedelta(days=7)
        )


class CountUsersLastMonth(StatsComputation):
    def __init__(self, session: AsyncSession):
        self._session = session

    async def compute(self) -> int:
        return await UserDAO.count_users_by_period(
            session=self._session, period=timedelta(days=30)
        )


class CountUsersTotal(StatsComputation):
    def __init__(self, session: AsyncSession):
        self._session = session

    async def compute(self) -> int:
        return await UserDAO.count_users_by_period(session=self._session)


@admin_router.callback_query(
    F.data == "statistic", F.from_user.id.in_(settings.ADMIN_IDS)
)
async def admin_statistic(
    call: CallbackQuery, session_without_commit: AsyncSession
):
    await call.answer("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
    await call.answer("üìä –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")

    dash = Dashboard(
        [
            DashboardStat(
                CountUsersTotal(session=session_without_commit),
                "üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            ),
            DashboardStat(
                CountUsersLastDay(session=session_without_commit),
                "üÜï –ù–æ–≤—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è",
            ),
            DashboardStat(
                CountUsersLastWeek(session=session_without_commit),
                "üìÖ –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é",
            ),
            DashboardStat(
                CountUsersLastMonth(session=session_without_commit),
                "üìÜ –ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü",
            ),
        ]
    )

    values = await dash.get_values()

    stats_message = "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
    for stat, value in values.items():
        stats_message += f"{stat.get_description_for_user()}: {value}"
        stats_message += "\n\n"
    stats_message += "üïí –î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç."

    await call.message.edit_text(text=stats_message, reply_markup=admin_kb())
